# ========================================
# Lyrebird Standalone Docker Compose
# ========================================
# Self-contained deployment - no repo clone needed!
#
# Usage:
#   curl -O https://raw.githubusercontent.com/0-sayed/lyrebird/main/docker-compose.standalone.yml
#   docker compose -f docker-compose.standalone.yml up -d
#
# Optional customization with .env file:
#   echo "DASHBOARD_PORT=8080" > .env
#   docker compose -f docker-compose.standalone.yml up -d

services:
  # ========================================
  # Infrastructure Services
  # ========================================

  # PostgreSQL with TimescaleDB Extension
  postgres:
    image: timescale/timescaledb:latest-pg16
    container_name: lyrebird-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DATABASE_USER:-postgres}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-lyrebird_secure_password}
      POSTGRES_DB: ${DATABASE_NAME:-lyrebird}
      POSTGRES_INITDB_ARGS: '-A md5'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U "$$POSTGRES_USER"']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - lyrebird-network
    # Database initialization via shell command (works in plain docker compose, not just Swarm)
    command:
      - 'sh'
      - '-c'
      - |
        cat > /docker-entrypoint-initdb.d/init.sql << 'EOSQL'
        -- ============================================================
        -- Lyrebird Database Schema
        -- Must match libs/database/migrations exactly!
        -- ============================================================

        -- Enable TimescaleDB extension
        CREATE EXTENSION IF NOT EXISTS timescaledb;

        -- Create jobs table (required for foreign key)
        CREATE TABLE IF NOT EXISTS "jobs" (
            "id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
            "prompt" text NOT NULL,
            "search_strategy" jsonb,
            "status" text DEFAULT 'pending' NOT NULL,
            "error_message" text,
            "created_at" timestamp DEFAULT now() NOT NULL,
            "updated_at" timestamp DEFAULT now() NOT NULL,
            "completed_at" timestamp
        );

        -- Create sentiment_data table with full schema
        CREATE TABLE IF NOT EXISTS "sentiment_data" (
            "id" uuid DEFAULT gen_random_uuid() NOT NULL,
            "job_id" uuid NOT NULL,
            "source" text NOT NULL,
            "source_url" text,
            "author_name" text,
            "text_content" text NOT NULL,
            "raw_content" text,
            "sentiment_score" real NOT NULL,
            "sentiment_label" text NOT NULL,
            "confidence" real,
            "upvotes" integer DEFAULT 0,
            "comment_count" integer DEFAULT 0,
            "published_at" timestamp NOT NULL,
            "collected_at" timestamp DEFAULT now() NOT NULL,
            "analyzed_at" timestamp DEFAULT now() NOT NULL,
            CONSTRAINT "sentiment_data_id_published_at_pk" PRIMARY KEY("id","published_at")
        );

        -- Add foreign key constraint
        ALTER TABLE "sentiment_data" ADD CONSTRAINT "sentiment_data_job_id_jobs_id_fk"
            FOREIGN KEY ("job_id") REFERENCES "public"."jobs"("id") ON DELETE cascade ON UPDATE no action;

        -- Convert to hypertable partitioned by published_at (7-day chunks)
        SELECT create_hypertable(
            'sentiment_data',
            'published_at',
            chunk_time_interval => INTERVAL '7 days',
            if_not_exists => TRUE
        );

        -- CRITICAL: Unique index required for ON CONFLICT deduplication
        -- TimescaleDB requires unique indexes to include the partitioning column
        CREATE UNIQUE INDEX IF NOT EXISTS sentiment_data_job_id_source_url_idx
            ON sentiment_data (job_id, source_url, published_at);

        -- Additional indexes for query performance
        CREATE INDEX IF NOT EXISTS sentiment_data_job_id_idx ON sentiment_data (job_id);
        CREATE INDEX IF NOT EXISTS sentiment_data_source_idx ON sentiment_data (source);
        CREATE INDEX IF NOT EXISTS sentiment_data_published_at_idx ON sentiment_data (published_at DESC);
        CREATE INDEX IF NOT EXISTS sentiment_data_collected_at_idx ON sentiment_data (collected_at DESC);
        CREATE INDEX IF NOT EXISTS sentiment_data_sentiment_score_idx ON sentiment_data (sentiment_score);

        -- Set up 90-day retention policy
        SELECT add_retention_policy(
            'sentiment_data',
            INTERVAL '90 days',
            if_not_exists => TRUE
        );

        -- Schema initialization complete
        -- All tables, indexes, and hypertable configured
        EOSQL
        exec docker-entrypoint.sh postgres

  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:4.0-management-alpine
    container_name: lyrebird-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-rabbitmq}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-lyrebird_secure_password}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-/}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ['CMD-SHELL', 'rabbitmq-diagnostics -q check_port_listener 5672']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - lyrebird-network

  # Redis Cache
  redis:
    image: redis:7.4-alpine
    container_name: lyrebird-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-lyrebird_secure_password}
    volumes:
      - redis_data:/data
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'redis-cli -a "${REDIS_PASSWORD:-lyrebird_secure_password}" ping | grep -q PONG',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - lyrebird-network

  # ========================================
  # Application Services (from GHCR)
  # ========================================

  # Gateway Service
  gateway:
    image: ghcr.io/0-sayed/lyrebird-gateway:${LYREBIRD_VERSION:-latest}
    container_name: lyrebird-gateway
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_USER: ${DATABASE_USER:-postgres}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-lyrebird_secure_password}
      DATABASE_NAME: ${DATABASE_NAME:-lyrebird}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: ${RABBITMQ_USER:-rabbitmq}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-lyrebird_secure_password}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1',
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - lyrebird-network

  # Ingestion Service
  ingestion:
    image: ghcr.io/0-sayed/lyrebird-ingestion:${LYREBIRD_VERSION:-latest}
    container_name: lyrebird-ingestion
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3001
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_USER: ${DATABASE_USER:-postgres}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-lyrebird_secure_password}
      DATABASE_NAME: ${DATABASE_NAME:-lyrebird}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: ${RABBITMQ_USER:-rabbitmq}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-lyrebird_secure_password}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/}
      JETSTREAM_MAX_DURATION_MS: ${JETSTREAM_MAX_DURATION_MS:-120000}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget --no-verbose --tries=1 --spider http://localhost:3001/health || exit 1',
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - lyrebird-network

  # Analysis Service
  analysis:
    image: ghcr.io/0-sayed/lyrebird-analysis:${LYREBIRD_VERSION:-latest}
    container_name: lyrebird-analysis
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3002
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_USER: ${DATABASE_USER:-postgres}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-lyrebird_secure_password}
      DATABASE_NAME: ${DATABASE_NAME:-lyrebird}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: ${RABBITMQ_USER:-rabbitmq}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-lyrebird_secure_password}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/}
      ML_MODEL_CACHE_DIR: /app/models-cache
      ML_QUANTIZATION: ${ML_QUANTIZATION:-q8}
    volumes:
      - models_cache:/app/models-cache
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget --no-verbose --tries=1 --spider http://localhost:3002/health || exit 1',
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - lyrebird-network

  # Dashboard Service
  dashboard:
    image: ghcr.io/0-sayed/lyrebird-dashboard:${LYREBIRD_VERSION:-latest}
    container_name: lyrebird-dashboard
    restart: unless-stopped
    ports:
      - '${DASHBOARD_PORT:-8080}:8080'
    depends_on:
      gateway:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget --no-verbose --tries=1 --spider http://127.0.0.1:8080/health || exit 1',
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    networks:
      - lyrebird-network

# Named volumes for data persistence
volumes:
  postgres_data:
    driver: local
  rabbitmq_data:
    driver: local
  redis_data:
    driver: local
  models_cache:
    driver: local

# Custom network for service communication
networks:
  lyrebird-network:
    driver: bridge
